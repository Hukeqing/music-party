<!DOCTYPE html>

<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
        <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
        <script type="text/javascript">
            function notification(notificationContainer = null) {
                let notifications = [];
                let totalHeight = 0;

                if(!notificationContainer) {
                    notificationContainer = document.createElement('div');
                    notificationContainer.id = 'notification-container';
                    document.body.appendChild(notificationContainer);
                }

                function updateTransform(isRemoving = false, removeNode = null) {
                    const transform = `translateY(calc(0px - (var(--notification-margin) * ${notifications.length}) - ${totalHeight}px))`;
                    if(!isRemoving) {
                        notifications.forEach(e=>e.style.transform = transform)
                    } else {
                        const all_notifications = Array.from(removeNode.parentNode.children);
                        const notifs_after = all_notifications.slice(all_notifications.indexOf(removeNode))

                        notifs_after.forEach(e=>{
                            e.style.transitionDuration = '0s';
                        })
                        notifications.forEach(e=>e.style.transform = transform)
                        notificationContainer.clientHeight;
                        notifs_after.forEach(e=>{
                            e.style.transitionDuration = '.5s';
                        })
                    }
                }

                async function removeElem(elem, elemHeight) {
                    if(notifications.filter(e=>e===elem).length) {
                        const hidePosition = notificationContainer.clientHeight - elem.getBoundingClientRect().top + 20;
                        const transformStr = elem.style.transform
                        new Animation(new KeyframeEffect(elem, [
                            {'transform': transformStr},
                            {'transform': `${transformStr.slice(0, -2)} - 10px))`},
                            {'transform': `${transformStr.slice(0, -2)} - 10px + ${hidePosition}px))`},
                        ], { duration: 500, fill: 'forwards' }), document.timeline).play()
                        await new Promise(s=>setTimeout(s, 500));
                        notifications = notifications.filter(e=>e!==elem);
                        totalHeight = Math.max(totalHeight - elemHeight, 0);
                        updateTransform(true, elem);
                        elem.remove();
                    }
                }

                return function showNotification(content, type = 'info', time = 5000) {
                    const elem = document.createElement('div');
                    elem.className = `notification ${type} clickable`;
                    elem.textContent = content;
                    notificationContainer.appendChild(elem);

                    const height = elem.clientHeight;
                    totalHeight += height;
                    notifications.push(elem);
                    updateTransform();

                    elem.onclick = () => removeElem(elem, height)
                    setTimeout(()=>removeElem(elem, height), time)
                }
            }
        </script>
        <script type="text/javascript">
window.onload = function() {
'use strict';

// SECTION: constants
const FILE_CHUNK_SIZE = 1024 * 1024;
const MEDIA_FRAGMENT_DURATION = 10;
const MAX_RETRY = 3;
let logged_in = false;

// SECTION: icon
const formatIcon = className => `<i class='bi bi-${className}'></i>`;

const Eye = formatIcon('eye');
const EyeSlash = formatIcon('eye-slash');
const SkipStartFill = formatIcon('skip-start-fill');
const SkipEndFill = formatIcon(`skip-end-fill`);
const PauseFill = formatIcon('pause-fill');
const Play = formatIcon('play');
const List = formatIcon('list');
const XLg = formatIcon('x-lg');
const Shuffle = formatIcon('shuffle');
const MusicNoteList = formatIcon('music-note-list');
const Repeat = formatIcon('repeat');
const RepeatOne = formatIcon('repeat-1');
const ListUl = formatIcon('list-ul');
const VolumeUpFill = formatIcon('volume-up-fill');
const VolumeDownFill = formatIcon('volume-down-fill');
const VinylFill = formatIcon('vinyl-fill');

// SECTION: components
const notificationContainer = document.getElementById('notification-container');
const popupContainer = document.getElementById('popup-container');
const popupWindow = document.getElementById('popup-window');
const main = document.getElementById('main');

// SECTION: notification
const showNotification = notification(notificationContainer);

// SECTION: popup
let popupWindowVisibility = false;

async function showPopup(buildPage) {
    if(!buildPage) {
        popupContainer.style.backgroundColor = 'unset';
        popupContainer.style.pointerEvents = 'none';
        popupWindow.style.transform = 'scale(0)';
        await new Promise(s=>setTimeout(s, 300));
        popupWindow.innerHTML = '';
        popupWindowVisibility = false;
    } else {
        popupContainer.style.backgroundColor = 'rgba(0,0,0,.7)';
        popupContainer.style.pointerEvents = 'initial';
        buildPage();
        popupWindow.style.transform = 'unset';
        popupWindowVisibility = true;
    }
}
const closePopup = () => showPopup(null);
popupContainer.onclick = evt => {
    if(evt.target === popupContainer) {
        closePopup();
    }
}

// SECTION: utils
function shuffle(arr) {
    return [...arr].sort(()=> .5 - Math.random())
}

// SECTION: pages
function askLogin() {

    if(Cookies.get('session-id')) {
        logged_in = true;
        return party();
    }
    logged_in = false;

    function submitLogin(evt) {
        evt.preventDefault();
        const account = evt.target.account.value;
        const password = evt.target.password.value;
        
        fetch(`/account/login`, {
            method: 'POST',
            body: JSON.stringify({account, password}),
            headers: {'Content-Type': 'application/json'}
        }).then(async res => {
            const { result, sessionID } = await res.json();
            if(result !== 'login-failed') {
                if(result === 'login-success') showNotification('登陆成功!', 'success')
                else if(result === 'account-created') showNotification('注册成功, 将为您登录', 'success')
                Cookies.set('session-id', sessionID, { expires: 365 } );
                if(evt.target['remember-password'].checked) {
                    localStorage.setItem('remember-password', true);
                    localStorage.setItem('account', account);
                    localStorage.setItem('password', password);
                } else if(localStorage.getItem('remember-password')) {
                    localStorage.removeItem('remember-password');
                    localStorage.removeItem('account');
                    localStorage.removeItem('password');
                }
                // go to party main
                party();
            } else {
                showNotification('密码不正确!', 'err')
            }
        })
    }

    main.innerHTML = `
    <form id='login-form'>
        <span class='description'>请输入账号密码登录，如果账号不存在将会直接创建</span>
        <input type='text' name='account' id='login-account' placeholder="请输入您的账号" >
        <div id='show-password' class='clickable'>${Eye}</div>
        <input type='password' name='password' id='login-password' placeholder='请输入您的密码' >
        <div class='remember-password-container'>
            <input type='checkbox' id='remember-password' name='remember-password'>
            <span>记住密码</span>
        </div>
        <button class='clickable' type='submit'>登录</button>
    </form>
    `

    let password_display = false;
    const password_elem = document.getElementById('login-password');
    const show_password_elem = document.getElementById('show-password');

    if(localStorage.getItem('remember-password')) {
        password_elem.value = localStorage.getItem('password');
        document.getElementById('login-account').value = localStorage.getItem('account');
        document.getElementById('remember-password').checked = true;
    }

    show_password_elem.onclick = () => {
        password_display = !password_display;
        show_password_elem.innerHTML = password_display ? EyeSlash : Eye;
        password_elem.type = password_display ? 'text' : 'password';
    }
    document.getElementById('login-form').onsubmit = submitLogin;
}

async function party() {

    const sessionID = Cookies.get('session-id')
    const user_login_validated = await (await fetch(`/account/validate-login`,{
        method: 'POST',
        body: JSON.stringify({ sessionID }),
        headers: { 'Content-Type': 'application/json' }
    })).json();
    if(!user_login_validated) {
        Cookies.remove('session-id');
        askLogin();
    }

    // init states
    const PLAY_WAYS = ['loop', 'single', 'random', 'playlist']

    let displaying = {
        type: '', elem: null, currentVolume: 0.5
    }

    const playStates = {
        playlist: {},
        playing: 0, order: [],
        random_order: [],
        _how: 'loop',
        set how(way) {
            this._how = way;
            how_to_play.innerHTML = 
                way === 'playlist' ? ListUl :
                way === 'single' ? RepeatOne : 
                way === 'random' ? Shuffle : 
                Repeat
            
            if(way === 'random') {
                playStates.random_order = shuffle(playStates.order)
            }
        },
        get how() {
            return this._how;
        }
    }
    
    let last_toggled_resize = 0;
    let manual_update_media_time = false,
        manual_toggle_play = false,
        can_sync_media_time = false;
    
    const roomMode = { 
        activate: false, playlist: {}, order: [], extra: {},
        syncProgress: null, exitRoom: null, requestUpdatePlaylist: null
    };

    // functions
    function loadHls(bound_elem, type) {
        const hls = Hls.isSupported() ?
            new Hls() : (function(){
                showNotification('您的浏览器不支持通过HLS播放!', 'error')
                Cookies.remove('session-id')
                askLogin();
            })();

        hls.attachMedia(bound_elem);

        return (url, startPlay = true)=>{
            hls.loadSource(url);
            if(displaying.type !== type) {
                if(displaying.elem) {
                    displaying.elem.style.display = 'none';
                    displaying.elem.pause();
                    displaying.type = type;
                }
                displaying.elem = bound_elem;
                bound_elem.style.display = 'block';
            }
            startPlay && bound_elem.play();
            bound_elem.volume = displaying.currentVolume;
        }
    }

    function getMediaDuration(media_file, fileType) {
        return new Promise(resolve => {
            const media_elem = document.createElement(fileType);
            const url = URL.createObjectURL(media_file);
            media_elem.preload = 'metadata';
            media_elem.onloadedmetadata = () => {
                resolve(media_elem.duration);
                URL.revokeObjectURL(url);
            }
            media_elem.src = url;
        })
    }

    async function uploadFile(file, rename, progressControl) {
        let totalChunks = Math.ceil(file.size / FILE_CHUNK_SIZE), 
            currentChunkIndex = 0,
            fileType = file.type.split('/').shift(),
            referenceID = -1, 
            updateProgress = progressControl(abort),
            retry = 0, pauseUpdateTill = 0;

        async function init() {
            const estFragments = Math.ceil((await getMediaDuration(file, fileType)) / MEDIA_FRAGMENT_DURATION);
            referenceID = + (await (await fetch('/playlist/pre-upload', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    sessionID,
                    title: (rename || file.name),
                    suffix: file.name.split('.').pop(),
                    fileType,
                    estChunks: totalChunks,
                    estFragments
                })
            })).text());
            cutFileChunk();
        }

        async function abort() {
            if(currentChunkIndex !== -1 && referenceID !== -1) {
                currentChunkIndex = -1;
                const abort_result = await (await fetch(`/playlist/`, {
                    method: 'DELETE',
                    body: JSON.stringify({id: referenceID, sessionID}),
                    headers: {'Content-Type': 'application/json'},
                })).json()
                
                updateProgress(`aborted${abort_result ? '' : '-failed'}`);
                if(!abort_result) {
                    pauseUpdateTill = Date.now() + 5000
                }
            }
        }

        function cutFileChunk() {
            if(currentChunkIndex < 0) return;

            const start = currentChunkIndex * FILE_CHUNK_SIZE;
            const end = Math.min(start + FILE_CHUNK_SIZE, file.size);
            sendFileChunk(file.slice(start, end));
        }

        async function sendFileChunk(chunk) {
            if(currentChunkIndex < 0) return;

            const isLastChunk = + (currentChunkIndex === totalChunks - 1)
            const searchParams = new URLSearchParams({
                sessionID, referenceID, chunkIndex: currentChunkIndex
            })

            const upload_result = await (await fetch(`/playlist/upload-chunk?${searchParams.toString()}`, {
                method: 'POST',
                body: chunk,
                headers: {'Content-Type': 'application/octet-stream'}
            })).json();

            if(upload_result) {
                if(isLastChunk) {
                    currentChunkIndex = -1;
                    updateProgress('waiting-process', 0);
                    const interval_id = setInterval(async () => {
                        const fragment_status = await getUploadProgress(referenceID);
                        if(pauseUpdateTill) {
                            if(Date.now() <= pauseUpdateTill) return;
                            pauseUpdateTill = 0;
                        }
                        if(!fragment_status.error_msg) {
                            updateProgress(
                                fragment_status.status === 'fragmenting' ?
                                'waiting-process' :
                                fragment_status.status === 'finished' ?
                                'finished' : 'upload', Math.floor(fragment_status.progress * 100))
                        }
                        (!popupWindowVisibility || fragment_status.error_msg || fragment_status.status === 'finished') && clearInterval(interval_id)
                    }, 1000);
                } else if(currentChunkIndex >= 0) {
                    currentChunkIndex ++;
                    updateProgress('upload', Math.floor((currentChunkIndex / (totalChunks - 1)) * 100))
                    cutFileChunk();
                }
            } else {
                if(retry < MAX_RETRY) {
                    retry ++;
                    cutFileChunk()
                    updateProgress('retry', retry)
                } else {
                    retry = 0;
                    updateProgress('failed')
                }
            }
        }

        init();
    }

    async function getPlaylist(playlist = null) {
        const user_playlists = playlist || await (await fetch(
            `/playlist/user-playlist?${new URLSearchParams({sessionID}).toString()}`)
        ).json()
        if(user_playlists.length) {
            for(const media of user_playlists) {
                if(roomMode.activate && playlist) {
                    roomMode.playlist[media.id] = media;
                    continue;
                }
                playStates.playlist[media.id] = media;
                playStates.order.includes(media.id) || playStates.order.push(media.id);
            }
        }
        if(roomMode.activate && !playlist) {
            roomMode.requestUpdatePlaylist()
        }
        return;
    }

    async function getUploadProgress(referenceID = -1) {
        const url = referenceID > 0 ? 'media' : 'user'
        const query = { sessionID }
        if(referenceID > 0) query.referenceID = referenceID;
        return await (
            await fetch(
                `/playlist/${url}-upload-status?${new URLSearchParams(query).toString()}`
            )
        ).json()
    }

    function togglePlay() {
        if(displaying.elem) {
            displaying.elem.paused ? displaying.elem.play() : displaying.elem.pause();
        } else if(((roomMode.activate && roomMode.order.length) || playStates.order.length) && playStates.playing === 0) {
            playNext(false);
        }
        manual_toggle_play = true;
    }

    function playMedia(isManualPlay = false) {
        const media_list = roomMode.activate ? roomMode.playlist : playStates.playlist
        const media = media_list[playStates.playing]
        media.type === 'audio' ?
            setAudioHls(`/playlist/${sessionID}/${media.id}/${media.filename}.m3u8`) :
            setVideoHls(`/playlist/${sessionID}/${media.id}/${media.filename}.m3u8`)

        if(document.querySelector("#playlist-main")) {
            document.querySelector("#playlist-main .media.playing").classList.remove('playing');
            document.querySelector(`#playlist-main #playlist-play-btn-${media.id}`).classList.add('playing');
        }

        if(media.type === 'audio') {
            audio_title_container.style.display = 'block';
            audio_title.textContent = media.title;
            audio_title.style.animationName = 'unset';
            audio_title.style.animationDuration = `${
                Math.max(
                    audio_title.clientWidth, 
                    audio_title_container.clientWidth
                ) / 70}s`;
            audio_title.style.animationName = 'music-title-scroll';

        } else {
            audio_title_container.style.display = 'none';
        }

        if(roomMode.activate && isManualPlay) roomMode.syncProgress()
    }

    function playNext(manual = true) {
        if(!(roomMode.activate && roomMode.order.length) && !playStates.order.length) return;
        if(playStates.how === 'single') {
            playMedia(manual); return;
        }
        const followOrder = 
            roomMode.activate ? roomMode.order : 
            playStates.how === 'random' ? playStates.random_order : 
            playStates.order
        const index = followOrder.indexOf(playStates.playing);
        // if is last
        if(index >= followOrder.length - 1) {
            if(roomMode.activate) {
                if(playStates.how === 'playlist') return;
                else playStates.playing = followOrder[0];
            } else {
                switch(playStates.how) {
                    case 'playlist': return;
                    case 'random':
                        playStates.random_order = shuffle(playStates.order);
                        playStates.playing = playStates.random_order[0];
                        break;
                    case 'loop':
                    default:
                        playStates.playing = playStates.order[0];
                        break;
                }
            }
        } else playStates.playing = followOrder[index + 1]
        playMedia(manual);
    }

    function playLast() {
        if((!(roomMode.activate && roomMode.order.length) && !playStates.order.length)) return;
        if(playStates.how === 'single') {
            playMedia(true); return;
        }
        const followOrder = 
            roomMode.activate ? roomMode.order : 
            playStates.how === 'random' ? playStates.random_order : 
            playStates.order
        const index = followOrder.indexOf(playStates.playing);
        // if is first
        if(index <= 0) {
            if(playStates.how === 'playlist') return;
            else playStates.playing = followOrder.slice(-1)[0]
        } else playStates.playing = followOrder[index - 1];
        playMedia(true);
    }

    function keyboardControl(evt) {
        // disable keyboard control when there's a popup window
        if(popupWindowVisibility || document.activeElement === displaying.elem) return;

        switch(evt.key) {
            case ' ': togglePlay(); break;
            case 'ArrowLeft': calculateSetProgressByTime(-5); break;
            case 'ArrowRight': calculateSetProgressByTime(5); break;
            case 'ArrowUp': setVolume(0.02); break;
            case 'ArrowDown': setVolume(-0.02); break;
            default: break;
        }
    }

    function interactableProgressBar(name, setElemProgress) {
        const states = { mouseDown: false, X: -1, width: -1, locOnPage: -1 }
        const container = document.querySelector(`#media-${name}-interactive.media-interactive-container`);
        const bar = document.querySelector(`#media-${name}-interactive.media-interactive-container .bar .bg`)
        const node = document.querySelector(`#media-${name}-interactive.media-interactive-container #node`)
        // read layout property to force render
        container.offsetWidth;

        container.onmousedown = () => {states.mouseDown = true}
        container.onmouseup = () => {
            if(name==='progress') can_sync_media_time = true;
            states.mouseDown = false
        }
        container.onmouseleave = () => {
            if(name==='progress' && states.mouseDown)
                can_sync_media_time = true;
            states.mouseDown = false
        }
        container.ontouchstart = () => {states.mouseDown = true}
        container.ontouchend = () => {
            if(name==='progress') can_sync_media_time = true;
            states.mouseDown = false
        }
        container.ontouchcancel = () => {
            if(name==='progress' && states.mouseDown)
                can_sync_media_time = true;
            states.mouseDown = false
        }
        container.onclick = evt => {
            states.X = evt.offsetX;
            calculateProgress(null, true);
        }
        container.onmousemove = evt => {
            states.X = evt.offsetX;
            states.mouseDown && calculateProgress(null, true);
        }
        container.ontouchmove = evt => {
            states.X = evt.changedTouches[0].pageX - states.locOnPage;
            states.mouseDown && calculateProgress(null, true);
        }
        function setUIProgress() {
            bar.style.transform = `translateX(${states.X}px)`;
            node.style.transform = `translateX(${states.X}px)`;
        }

        function updateWidth() {
            states.width = container.offsetWidth;
            states.locOnPage = container.getBoundingClientRect().left
        }

        function calculateProgress(params = {value: null, total: null}, isInside = false) {
            states.X = Math.max(Math.min(states.width, states.X), 0)
            if(isInside) {
                setElemProgress(states.X / states.width);
            } else {
                const {value, total} = params;
                states.X = Math.round(states.width * (value / total));
                setUIProgress()
            }
        }

        updateWidth();

        return [calculateProgress, updateWidth]
    }

    function windowResized() {
        if(Date.now() - last_toggled_resize < 100) return;
        last_toggled_resize = Date.now();

        updateMediaProgressWidth();
        updateMediaVolumeWidth();
        checkPartyOverflow();
    }
    
    function checkPartyOverflow() {
        // check observers to determine overflow
        if(
            top_observer.getBoundingClientRect().top < 0 ||
            bottom_observer.getBoundingClientRect().top > party_page.offsetHeight
        ) {
            party_page.style.overflowY = 'scroll';
        } else {
            party_page.style.overflowY = 'hidden';
        }
    }

    function calculateSetProgressByTime(time = 0) {
        if(!displaying.elem) return;
        let duration = displaying.elem.duration,
            currentTime = displaying.elem.currentTime;
        time = Math.max(Math.min(currentTime + time, duration), 0);
        displaying.elem.currentTime = time;
        can_sync_media_time = true;
    }

    function setVolume(change) {
        if(!displaying.elem) return;
        const newVol = Math.max(Math.min(displaying.currentVolume + change, 1), 0);
        displaying.elem.volume = newVol;
    }

    function mediaElemEvtListeners() {
        let media_time_update_cooldown = 0;

        function mediaVolumeChanged() {
            displaying.currentVolume = displaying.elem.volume;
            calculateMediaVolume({
                value:  displaying.currentVolume,
                total: 1
            })
        }
        function updatePlayIcon() {
            if(displaying.elem) {
                if(displaying.elem.paused) {
                    toggle_play_btn.innerHTML = Play;
                    toggle_play_btn.title = '播放';
                } else {
                    toggle_play_btn.innerHTML = PauseFill;
                    toggle_play_btn.title = '暂停';
                }
            }
            roomMode.activate && manual_toggle_play && roomMode.syncProgress();
            manual_toggle_play = false;
        }
        function mediaTimeUpdated() {
            if(Date.now() < media_time_update_cooldown && !manual_update_media_time) return;
            media_time_update_cooldown = Date.now() + 100;

            if(can_sync_media_time && roomMode.activate) roomMode.syncProgress();

            manual_update_media_time = false;
            can_sync_media_time = false;

            if(displaying.elem) {
                calculateMediaProgress({
                    value: displaying.elem.currentTime,
                    total: displaying.elem.duration
                })
            }
        }

        video_component.onended = playNext;
        audio_component.onended = playNext;

        video_component.onvolumechange = mediaVolumeChanged;
        audio_component.onvolumechange = mediaVolumeChanged;
        
        video_component.onpause = updatePlayIcon;
        audio_component.onpause = updatePlayIcon;
        video_component.onplay = updatePlayIcon;
        audio_component.onplay = updatePlayIcon;

        video_component.ontimeupdate = mediaTimeUpdated;
        audio_component.ontimeupdate = mediaTimeUpdated;
    }

    function updateTextScrollAnimation(elem, parentElem = null, pauseAfterFinish = 2000, speed = 70) {
        parentElem = parentElem || elem.parentElement;

        let not_available = elem.offsetWidth <= parentElem.offsetWidth,
            moveDistance = elem.offsetWidth - parentElem.offsetWidth + 10,
            last_update_time = Date.now(),
            play_end = false,
            position = 0;
        
        function move() {
            not_available || requestAnimationFrame(move)
            const time_past = Date.now() - last_update_time;
            if(!play_end) {
                elem.style.transform = `translateX(${Math.floor(position)}px)`;
                position -= last_update_time < 0 ? 0 : time_past / 1000 * speed;
                last_update_time = Date.now();
                if(Math.abs(position) > moveDistance) {
                    play_end = true;
                    position = 0;
                }
            } else if(time_past >= pauseAfterFinish) {
                play_end = false;
                last_update_time = Date.now();
            }
        }
        not_available || requestAnimationFrame(move)

        return function requestUpdate() {
            const previous_available = not_available;
            not_available = elem.offsetWidth <= parentElem.offsetWidth;
            moveDistance = elem.offsetWidth - parentElem.offsetWidth + 10;
            last_update_time = Date.now();
            play_end = false;
            position = 0;

            !not_available && !previous_available && requestAnimationFrame(move)
        }
    }

    // main page
    main.innerHTML = `
    <div id='party'>
        <div class='overflow-observer' name='top-observer'></div>
        <div class='party-main'>
            <div class='media-container-block'>
                <div class='media-container'>
                    <div class='music-title-container'>
                        <div class='music-title'><div class='music-title-text'></div></div>
                        ${VinylFill}
                    </div>
                    <video id='video-component' controls></video>
                    <audio id='audio-component'></audio>
                </div>
            </div>
            <div id='media-progress-interactive' class='media-interactive-container clickable'>
                <div class='bar'><div class='bg'></div></div>
                <div id='node'></div>
            </div>
            <div class='controllers'>
                <div class='controller clickable sub-icon' id='show-playlist-icon' title='播放列表'>${MusicNoteList}</div>
                <div class='controller clickable' id='last' title='上一媒体'>${SkipStartFill}</div>
                <div class='controller clickable' id='toggle-play' title='播放'>${Play}</div>
                <div class='controller clickable' id='next' title='下一媒体'>${SkipEndFill}</div>
                <div class='controller clickable sub-icon' id='how-to-play' title='切换播放方式'>${Repeat}</div>
            </div>
            <div id='media-volume-interactive' class='media-interactive-container clickable'>
                ${VolumeDownFill}
                <div class='bar'><div class='bg'></div></div>
                <div id='node'></div>
                ${VolumeUpFill}
            </div>
        </div>
        <div id='nav-bar'>
            <div class='clickable' id='hamburger-icon'>${List}</div>
            <div class='items'>
                <div class='item clickable' id='user-center'><div>用户中心</div></div>
                <div class='item clickable' id='get-playlist'><div>播放列表</div></div>
                <div class='item clickable' id='update-playlist'><div>更新播放列表</div></div>
                <div class='item clickable' id='upload-media'><div>上传媒体文件</div></div>
                <div class='item clickable' id='upload-manager'><div>管理我的上传</div></div>
                <div class='item clickable' id='join-room-menu'><div>创建/加入房间</div></div>
                <div class='item clickable' id='logout'><div>退出登录</div></div>
            </div>
        </div>
        <div class='overflow-observer' name='bottom-observer'></div>
    </div>`

    // components on main page
    const video_component = document.getElementById('video-component');
    const audio_component = document.getElementById('audio-component');
    const audio_title_container = document.querySelector('.media-container .music-title-container')
    const audio_title = document.querySelector('.media-container .music-title-container .music-title .music-title-text')
    
    // observers and references
    const top_observer = document.querySelector('.overflow-observer[name="top-observer"]');
    const bottom_observer = document.querySelector('.overflow-observer[name="bottom-observer"]');
    const party_page = document.getElementById('party');

    const setVideoHls = loadHls(video_component, 'video');
    const setAudioHls = loadHls(audio_component, 'audio');

    const toggle_play_btn = document.getElementById('toggle-play')
    const how_to_play = document.getElementById('how-to-play')

    // listeners
    mediaElemEvtListeners();

    toggle_play_btn.onclick = togglePlay;
    document.getElementById('last').onclick = playLast
    document.getElementById('next').onclick = playNext
    document.getElementById('show-playlist-icon').onclick = () => showPopup(showPlaylist)
    how_to_play.onclick = function() {
        if((!(roomMode.activate && roomMode.order.length) && !playStates.order.length)) return;
        const idx = PLAY_WAYS.indexOf(playStates.how)
        playStates.how = PLAY_WAYS[idx === PLAY_WAYS.length - 1 ? 0 : idx + 1]

        if(roomMode.activate) {
            roomMode.requestUpdatePlaylist(true);
        }
    }
    
    window.addEventListener('resize', windowResized);
    document.addEventListener('keydown', keyboardControl)
    
    const [calculateMediaProgress, updateMediaProgressWidth] = interactableProgressBar('progress', value => {
        manual_update_media_time = true;
        if(displaying.elem) displaying.elem.currentTime = displaying.elem.duration * value;
    })
    const [calculateMediaVolume, updateMediaVolumeWidth] = interactableProgressBar('volume', value => {
        if(displaying.elem) displaying.elem.volume = value;
    })
    

    // nav bar
    const nav_bar = document.getElementById('nav-bar');
    document.getElementById('hamburger-icon').onclick = () => {
        nav_bar.classList.toggle('expanded-nav-bar')
    }
    
    // nav bar items
    function uploadMediaFile() {
        popupWindow.innerHTML = `
        <div id='upload-media-container'>
            <div class='upload-file-container'>
                <input type='file' name='media-files' id='files-input' class='clickable' multiple>
                <div class='show-upload'><span>点击或拖拽文件到此处以上传</span></div>
            </div>
            <div class='btn-container'>
                <button id='upload-btn'>上传</button>
                <button id='cancel-btn'>取消</button>
            </div>
        </div>
        `

        function updateProgress(playlist_name, elem, bgElem, stats) {
            let updateAnimation = updateTextScrollAnimation(elem)
            const updatedAnimation = {
                'upload': false,
                'waiting-process': false
            }
            return function(abort) {
                stats.abort = abort;
                return function(progress, additional = null) {
                    if(progress === 'finished') getPlaylist()

                    const msg = 
                        progress === 'upload' ? `[${playlist_name}] 上传中... ${additional < 10 && '0' || ''}${additional}%` :
                        progress === 'waiting-process' ? `[${playlist_name}] 生成分片文件中... ${additional < 10 && '0' || ''}${additional}%` :
                        progress === 'finished' ? `[${playlist_name}] 上传完成!` : 
                        progress === 'aborted' ? `[${playlist_name}] 上传中断!` : 
                        progress === 'aborted-failed' ? `[${playlist_name}] 上传无法中断, 请等待上传完成后手动删除!` : 
                        progress === 'failed' ? `[${playlist_name}] 上传重试${MAX_RETRY}次后失败, 请尝试重新上传或联系管理员!` : 
                        progress === 'retry' ? `[${playlist_name}] 上传失败, 重试第${additional}次.` : 
                        ''

                    if(!popupWindowVisibility) {
                        if(progress === 'upload' || progress === 'waiting-process') return;
                        
                        showNotification(
                            msg,
                            progress === 'aborted' || progress === 'failed' ? 'err' : 
                            progress === 'aborted-failed' || progress === 'retry' ? 'warn' : 
                            'success'
                        )
                        return;
                    } else {
                        elem.textContent = msg;

                        bgElem.style.backgroundColor = 'lightgreen';
                        elem.style.color = `black`;

                        if(progress === 'upload' || progress === 'waiting-process') {
                            bgElem.style.transform = `translateX(-${100 - additional}%)`
                            if(!updatedAnimation[progress]) {
                                updatedAnimation[progress] = true;
                                updateAnimation();
                            }
                            return;
                        } else if(progress === 'retry') {
                            bgElem.style.backgroundColor = `gold`;
                            updatedAnimation['upload'] = false;
                            updatedAnimation['waiting-process'] = false;
                        } else {
                            bgElem.style.transform = 'translateX(0)';
                            stats.finished = true;
                            switch(progress) {
                                case 'finished': break;
                                case 'aborted':
                                case 'failed':
                                    bgElem.style.backgroundColor = `red`;
                                    elem.style.color = `white`;
                                    break;
                                case 'aborted-failed':
                                    bgElem.style.backgroundColor = `gold`;
                                    break;
                                default: stats.finished = false;
                            }
                        }
                        updateAnimation();
                        return;
                    }
                }
            }
        }

        const uploadMediaContainer = document.getElementById('upload-media-container'),
                uploadBtn = document.getElementById('upload-btn'),
                cancelBtn = document.getElementById('cancel-btn')

        const selectedFiles = []

        const filesInput = document.getElementById('files-input')
        filesInput.onchange = evt => {
            const files = evt.target.files;
            const all_files_index = selectedFiles.length

            for(var i = 0, j = all_files_index; i < files.length; i ++, j ++) {
                const file = files[i];
                if(! /^(audio|video)\/.*$/.test(file.type)) {
                    showNotification(`[${file.name}]不是视频/音频文件！`, 'err');
                    j --;
                    continue;
                }
                const index = j;

                const displayElemContainer = document.createElement('div');
                displayElemContainer.className = 'progress-bar';

                const defaultName = file.name.split('.').slice(0, -1).join('.')
                
                const renameInput = document.createElement('input')
                renameInput.type = 'text';
                renameInput.placeholder = defaultName;
                renameInput.value = defaultName;
                renameInput.oninput = evt => {
                    const value = evt.target.value;
                    selectedFiles[index].rename = value;
                }

                const removeFile = document.createElement('div')
                removeFile.className = 'remove-file clickable';
                removeFile.innerHTML = XLg;
                removeFile.onclick = () => {
                    selectedFiles.splice(index, 1, null);
                    displayElemContainer.remove();
                }

                displayElemContainer.appendChild(renameInput);
                displayElemContainer.appendChild(removeFile);
                uploadBtn.parentElement.insertAdjacentElement('beforebegin', displayElemContainer)

                selectedFiles[index] = {
                    rename: defaultName, finished: false,
                    file, displayElemContainer
                }
            }
        }

        function cleanUp() {
            selectedFiles.length = 0;
            closePopup();
        }

        uploadBtn.onclick = () => {
            filesInput.disabled = true;
            const finishBtn = document.createElement('button');
            finishBtn.onclick = () => {
                if(!selectedFiles.filter(e=>!e.finished).length) {
                    cleanUp()
                } else {
                    showNotification('还有未完成上传的文件!', 'err');
                }
            }
            finishBtn.textContent = '完成';
            uploadBtn.insertAdjacentElement('beforebegin', finishBtn)
            uploadBtn.remove();
            cancelBtn.onclick = () => {
                const isAllFinished = !selectedFiles.filter(e=>!e.finished).length
                if(!isAllFinished) {
                    selectedFiles.forEach(e=>{
                        e && e.abort && e.abort();
                    })
                    cancelBtn.onclick = cleanUp;
                } else cleanUp();
            }

            selectedFiles.forEach(e=>{
                if(!e) return;

                const { file, rename, displayElemContainer } = e;
                displayElemContainer.innerHTML = '';

                const progress_background = document.createElement('div')
                progress_background.className = 'progress-background';
                displayElemContainer.appendChild(progress_background)

                const progress_text = document.createElement('div')
                progress_text.className = 'progress-text';
                progress_text.textContent = `[${rename || file.name}] 等待上传中...`;
                displayElemContainer.appendChild(progress_text)

                uploadFile(file, rename, updateProgress(rename||file.name, progress_text, progress_background, e));
            })
        }

        cancelBtn.onclick = cleanUp;
    }
    async function showPlaylist() {
        if(popupWindowVisibility) popupWindow.innerHTML = ''

        const playlist_main = document.createElement('div')
        playlist_main.id = 'playlist-main'
        
        const loading_playlist_order = roomMode.activate ? roomMode.order : playStates.order
        const loading_playlist = roomMode.activate ? roomMode.playlist : playStates.playlist
        if(loading_playlist_order.length) {
            loading_playlist_order.forEach(id=>{
                const media = loading_playlist[id];
                if(!media) return;

                const playBtn = document.createElement('div');
                playBtn.className = 'media clickable'
                media.id === playStates.playing && playBtn.classList.add('playing')
                playBtn.id = `playlist-play-btn-${media.id}`;

                const playBtnText = document.createElement('div')
                playBtnText.className = 'title-text';
                playBtnText.textContent = media.title;
                
                playBtn.onclick = () => {
                    const last_playing = document.querySelector('#popup-window #playlist-main .media.playing')
                    last_playing && last_playing.classList.remove('playing')
                    playBtn.classList.add('playing')
                    playStates.playing = media.id;
                    playMedia(true);
                }
                
                playBtn.appendChild(playBtnText);
                playlist_main.appendChild(playBtn);

                updateTextScrollAnimation(playBtnText);
            })
        } else {
            playlist_main.innerHTML = `<div class='info'>您当前没有播放列表</div>`
        }
        
        popupWindow.appendChild(playlist_main)
    }
    async function uploadManager() {
        function updateUploadingProgress(elem, displayElem, status, progress, isFirstTime = false) {
            const progress_percent = Math.floor(Math.max(progress * 100, 0))
            elem.textContent = '上传进度: ' +
                status === 'pending' ? '正在上传文件' : 
                status === 'fragmenting' ? `正在进行文件分片, 进度${progress_percent}%` : 
                '上传已完成'
            displayElem.style.transform = `translateX(-${100-progress_percent}%)`;
            if(progress === 'finished' && !isFirstTime) getPlaylist()
        }

        popupWindow.innerHTML = `
        <div id='upload-manager-main'>
            <div id='loading' class='info'>正在加载上传记录</div>
        </div>`

        const user_upload_progress = await getUploadProgress();
        document.getElementById('loading').remove();
        const upload_manager_main = document.getElementById('upload-manager-main');
        if(user_upload_progress.length) {
            user_upload_progress.forEach(upload => {
                let { id, title, status, progress, playlist_id } = upload;
                let interval_id;

                const manageBlock = document.createElement('div');
                manageBlock.className = 'manage-block';

                const titleText = document.createElement('input');
                titleText.className = 'title';
                titleText.value = title;

                const statusText = document.createElement('div');
                statusText.className = 'status';
                
                if(status !== 'finished') {
                    interval_id = setInterval(async () => {
                        const updated_progress = await getUploadProgress(id);
                        if(!updated_progress.error_msg) {
                            status = updated_progress.status
                            progress = updated_progress.progress
                            updateUploadingProgress(statusText, statusDisplayBarBg, status, progress);
                        }
                        (!popupWindowVisibility || updated_progress.error_msg || updated_progress.status === 'finished') && clearInterval(interval_id)
                    }, 1000);
                }

                const statusDisplayBar = document.createElement('div');
                statusDisplayBar.className = 'progress-bar'

                const statusDisplayBarBg = document.createElement('div');
                statusDisplayBarBg.className = 'progress-bar-bg'
                statusDisplayBar.appendChild(statusDisplayBarBg);

                const renameBtn = document.createElement('div');
                renameBtn.className = 'function-btn clickable'
                renameBtn.textContent = '更新标题'
                renameBtn.onclick = async () => {
                    if(titleText.value && titleText.value !== title) {
                        const update_result = (await fetch(`/playlist/update-title`, {
                            method: 'POST',
                            body: JSON.stringify({ sessionID, id, title: titleText.value }),
                            headers: { 'Content-Type': 'application/json' }
                        })).json()
                        if(!update_result.error_msg && update_result) {
                            title = titleText.value;
                            showNotification(`[${title}] 更新标题成功!`, 'success')
                            getPlaylist();
                        } else  {
                            showNotification(`[${title}] 更新标题失败!`, 'error')
                        }
                    } else {
                        showNotification(`[${title}] 标题未改变!`)
                    }
                }

                const deleteBtn = document.createElement('div');
                deleteBtn.className = 'function-btn clickable danger'
                deleteBtn.textContent = '删除此文件'
                let last_click = 0;
                deleteBtn.onclick = async () => {
                    if(status !== 'fragmenting') {
                        if(Date.now() - last_click > 10000) {
                            showNotification('请再点击一次以确认删除', 'info', 10000);
                            last_click = Date.now();
                        } else {
                            const delete_result = await (await fetch(`/playlist`, {
                                method: 'DELETE',
                                body: JSON.stringify({ sessionID, id }),
                                headers: { 'Content-Type': 'application/json' }
                            })).json()
                            if(!delete_result.error_msg && delete_result) {
                                showNotification(`成功删除 [${title}]!`, 'success');
                                manageBlock.remove();
                                if(playlist_id) {
                                    playStates.order.splice(playStates.order.indexOf(playlist_id), 1)
                                    delete playStates.playlist[playlist_id]
                                    if(roomMode.activate) roomMode.extra.deletePlaylist = playlist_id;
                                }
                                getPlaylist();
                                if(interval_id) clearInterval(interval_id);
                            } else {
                                showNotification(`删除 [${title}] 失败!`, 'error');
                            }
                        }
                    } else {
                        showNotification('文件分片时无法删除, 请等待分片完成!', 'warn')
                    }
                }

                manageBlock.appendChild(titleText);
                manageBlock.appendChild(statusText);
                manageBlock.appendChild(statusDisplayBar);
                manageBlock.appendChild(renameBtn);
                manageBlock.appendChild(deleteBtn);
                upload_manager_main.appendChild(manageBlock);

                updateUploadingProgress(statusText, statusDisplayBarBg, status, progress, true);
            })
        } else {
            upload_manager_main.innerHTML = "<div class='info'>暂无上传记录!</div>"
        }

    }
    function room(roomCode = null) {
        const ws_urls = /^(http|https):\/\/([^\/]*).*$/.exec(window.location.href).slice(1, 3)
        const ws = new WebSocket(`ws${ws_urls[0] === 'https' ? 's' : ''}://${ws_urls[1]}/ws/room`);
        let userID, roomID;

        function handleMessage(msg) {
            switch(msg.msgType) {
                case 'joined-room':
                    if(msg.content.userID) {
                        joinedRoom(msg.content)
                        showNotification(`已成功加入房间${roomID}!`)
                    } else {
                        showNotification(`用户${msg.content.userName}已加入房间!`)
                    }
                    syncPlaylist(msg.content);
                    break;
                case 'room-created':
                    joinedRoom(msg.content)
                    roomMode.order = playStates.order;
                    roomMode.playlist = playStates.playlist;
                    showNotification(`已成功创建房间, 房间号为: ${roomID}`)
                    break;
                case 'request-sync-progress':
                    sendCurrentInfo('respond-sync')
                    break;
                case 'sync-progress':
                    syncProgress(msg.content);
                    break;
                case 'update-play-way':
                case 'update-playlist':
                    syncPlaylist(msg.content)
                    break;
                case 'update-too-frequent':
                    showNotification('跳的太快啦, 大家要跟不上了啦')
                    break;
                case 'ejection':
                    showNotification('房间的连接已被拒绝!', 'warning')
                    closeConnection(); return;
                case 'session-end':
                    showNotification('已离开房间, 返回单人模式')
                    closeConnection(); return;
                case 'room-not-exist':
                    showNotification('请求加入的房间不存在, 请确认您输入的房间号是否正确', 'warning')
                    closeConnection(); return;
                default: return;
            }
        }

        function joinedRoom(content) {
            userID = content.userID;
            roomID = content.roomID;
            roomMode.activate = true;
            roomMode.syncProgress = sendCurrentInfo;
            roomMode.exitRoom = exitRoom;
            roomMode.requestUpdatePlaylist = requestUpdatePlaylist;
            updateJoinRoomMenu()
        }

        function closeConnection() {
            ws.close();
        }

        function syncPlaylist({playlistOrder, playlistInfo, howToPlay}) {
            roomMode.order = playlistOrder;
            playStates.how = howToPlay;
            playlistInfo && getPlaylist(playlistInfo);
        }

        function syncProgress(waiting_sync) {
            const { playlistID, progress, isPaused, delayed, date } = waiting_sync;
            if(playlistID !== playStates.playing) playStates.playing = playlistID;
            playMedia();
            displaying.elem.currentTime = isPaused || delayed < 100 ? progress : progress + (delayed + (Date.now() - date)) / 1000
            isPaused && displaying.elem.pause();
        }

        function requestUpdatePlaylist(wayOnly = false) {
            // send update request
            if(wayOnly) {
                ws.send(JSON.stringify({
                    msgType: 'switch-play-way',
                    roomID, userID,
                    content: { howToPlay: playStates.how }
                }))
            } else {
                const content = { playlist: playStates.order }
                if(roomMode.extra.deletePlaylist) {
                    content.deletePlaylist = roomMode.extra.deletePlaylist;
                    delete roomMode.extra.deletePlaylist
                }
                ws.send(JSON.stringify({
                    msgType: 'update-playlist',
                    roomID, userID,
                    content
                }))
            }
        }

        function sendCurrentInfo(msgType = 'sync') {
            ws.send(JSON.stringify({
                roomID, userID, msgType,
                content: {
                    playlistID: playStates.playing,
                    duration: displaying.elem ? displaying.elem.duration : 0,
                    progress: displaying.elem ? displaying.elem.currentTime : 0,
                    isPaused: displaying.elem ? displaying.elem.paused : true,
                    date: Date.now()
                }
            }))
        }

        function exitRoom() {
            ws.send(JSON.stringify({ roomID, userID, msgType: 'exit-room' }))
        }

        ws.onopen = () => {
            const sendContent = { sessionID, playlist: playStates.order, how: playStates.how }
            if(roomCode) sendContent.requestRoomID = roomCode
            ws.send(JSON.stringify({
                msgType: roomCode ? 'join-room' : 'create-room',
                content: sendContent
            }))
        }

        ws.onmessage = msg => {
            handleMessage(JSON.parse(msg.data));
        }

        ws.onerror = err => {
            console.error(err);
        }

        ws.onclose = () => {
            roomMode.activate = false;
            roomMode.syncProgress = null;
            roomMode.exitRoom = null;
            roomMode.requestUpdatePlaylist = null;
            roomMode.playlist = {};
            roomMode.order = [];
            roomMode.extra = {};

            if(popupWindowVisibility) showPopup(roomPopup);
            const join_room_menu = document.getElementById('join-room-menu')
            join_room_menu.onclick = () => showPopup(roomPopup);
            join_room_menu.firstElementChild.textContent = '创建/加入房间';
            
            showNotification('与房间的连接已断开');
        }

        function updateJoinRoomMenu() {
            function newRoomPopup() {
                popupWindow.innerHTML = 
                `<div class='room-popup'>
                    <div class='room-info'>您当前所在的房间号是<strong>${roomID}</strong></div>
                    <button id='exit-room' class='clickable'>离开房间</button>
                </div>`

                document.getElementById('exit-room').onclick = () => {
                    exitRoom();
                }
            }
            const join_room_menu = document.getElementById('join-room-menu')
            join_room_menu.onclick = () => showPopup(newRoomPopup)
            join_room_menu.firstElementChild.textContent = '查看/离开房间';
            showPopup(newRoomPopup);
        }
    }
    function roomPopup() {
        popupWindow.innerHTML = 
        `<div class='room-popup'>
            <button class='clickable' id='create-room'>点击创建房间</button>
            <form id='join-room' autocomplete='off'>
                <input type='text' name='room-code' placeholder='房间号'>
                <button class='clickable' type='submit'>加入房间</button>
            </form>
        </div>
        `

        document.getElementById('create-room').onclick = () => {room(null)};
        document.getElementById('join-room').onsubmit = evt => {
            evt.preventDefault();
            const code = evt.target['room-code'].value;
            if(!code || !/^[0-9]{4}$/.test(code)) {
                showNotification('请填写正确的房间号以加入');
            } else {
                room(code);
            }
        }
        
    }

    document.getElementById('user-center').onclick = () => {showNotification('这个功能还在开发中~')}
    document.getElementById('get-playlist').onclick = () => showPopup(showPlaylist);
    document.getElementById('update-playlist').onclick = async () => { await getPlaylist(); showNotification('更新完成') };
    document.getElementById('upload-media').onclick = () => showPopup(uploadMediaFile);
    document.getElementById('upload-manager').onclick = () => showPopup(uploadManager);
    document.getElementById('join-room-menu').onclick = () => showPopup(roomPopup);
    document.getElementById('logout').onclick = () => {
        // clean up
        closePopup();
        Cookies.remove('session-id');
        window.removeEventListener('resize', windowResized);
        document.removeEventListener('keydown', keyboardControl);
        roomMode.activate && roomMode.exitRoom();
        // process to login
        askLogin();
        showNotification('登出成功!', 'success')
    }
    
    // init
    // load playlist info on load
    getPlaylist();
    // check if party page should overflow
    checkPartyOverflow();
}

// SECTION: start
document.onerror = err => { showNotification(err.message, 'error') }
askLogin();
}
        </script>
        <style type="text/css">
/* global */

body {
    margin: 0;
    padding: 0;
}

div {
    display: block;
    box-sizing: border-box;
}

#main {
    width: 100vw;
    height: 100vh;
    max-height: -webkit-fill-available;
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1;
    overflow-y: auto;
}

.clickable:hover {cursor: pointer;}

@keyframes music-title-scroll {
from { transform: translateX(var(--music-title-size)); }
to { transform: translateX(-100%); }
}

@media screen and (min-width: 1024px) {
    ::-webkit-scrollbar {width: 7px;}
    ::-webkit-scrollbar-track {background-color: rgb(240, 240, 240);}
    ::-webkit-scrollbar-thumb {background-color: rgb(160, 160, 160); border-radius: 3px;}
    ::-webkit-scrollbar-thumb:hover {background-color: grey;}
}

/* notifications */

#popup-container,
#notification-container {
    width: 100vw;
    height: 100vh;
    position: fixed;
    top: 0;
    left: 0;
    pointer-events: none;
}

#notification-container {
    z-index: 100;
    --notification-margin: 20px;

    .notification {
        position: relative;
        top: 100%;
        transition-duration: .5s;
        margin: auto;
        margin-bottom: var(--notification-margin);
        width: 20%;
        height: fit-content;
        padding: 20px;
        color: white;
        z-index: 5;
        pointer-events: initial;
        border-radius: 7px;
        font-size: 15px;
        text-align: center;
    }

    .notification.info { background-color: dodgerblue; }
    .notification.success { background-color: limegreen; }

    .notification.err,
    .notification.error { background-color: red; }

    .notification.warn,
    .notification.warning { background-color: gold; text-shadow: 1px 1px 2px black; }
}


/* popup */
#popup-container {
    z-index: 50;
    transition-duration: .3s;

    #popup-window {
        position: absolute;
        transform: scale(0);
        transform-origin: center;
        transition-duration: .3s;
        width: 50%;
        height: 50%;
        margin: 15vh 25%;
        background-color: white;
        border: 1px solid gray;
        border-radius: 7px;
        pointer-events: initial;
        overflow-y: auto;
        padding: 20px;
    }
}

/* login */

#login-form {
    --input-width: 25vw;
    --input-height: 50px;
    --show-pass-icon-height: 25px;

    width: fit-content;
    max-width: calc(var(--input-width) + 30px);
    height: fit-content;
    display: block;
    position: relative;
    margin: auto;
    margin-top: 20vh;
    text-align: center;
    margin-bottom: 50px;
    
    #show-password {
        position: absolute;
        height: var(--input-height);
        width: var(--input-height);
        margin-left: calc(var(--input-width) - var(--input-height));
        padding: calc((var(--input-height) - var(--show-pass-icon-height)) / 2);
    }
    #show-password i {
        display: block;
    }
    
    .remember-password-container {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        align-items: center;
    }
    .remember-password-container span {
        display: inline-block;
        margin: auto;
        margin-left: 5px;
    }
    .remember-password-container input {
        display: inline-block;
        margin: auto;
        margin-right: 5px;
        width: 20px;
        height: 20px;
    }
}
#login-form input:not(input[type='checkbox']) {
    width: var(--input-width);
    height: var(--input-height);
    border: 1px solid black;
    border-radius: 10px;
    display: block;
    margin: 20px auto;
    padding: 0 20px;
    box-sizing: border-box;
}
#login-form input:focus {outline: none;}
#login-form button {
    width: calc(var(--input-width) - 50px);
    height: calc(var(--input-height) - 10px);
    box-sizing: border-box;
    border-radius: 10px;
    border: 1px solid black;
    background-color: red;
    color: white;
    font-size: 17px;
    transition-duration: .5s;
}
#login-form button:hover {
    background-color: crimson;
}


/* party */
#party {
    --nav-bar-width: 50px;
    --nav-bar-item-width: 200px;
    --nav-bar-left-padding: 35px;
    --nav-bar-right-padding: 5px;
    --media-container-height: 500px;
    --controllers-height: 30px;
    
    position: fixed;
    height: 100%;
    width: 100%;

    #nav-bar {
        width: calc(var(--nav-bar-item-width) + var(--nav-bar-width) + var(--nav-bar-left-padding) + var(--nav-bar-right-padding) + 7px);
        height: 100%;
        position: fixed;
        top: 0;
        left: 0;
        border-right: 1px solid grey;
        padding: 50px var(--nav-bar-right-padding) 0px var(--nav-bar-left-padding);
        transform: translateX(calc(0px - (100% - var(--nav-bar-width))));
        transition-duration: .5s;
        z-index: 5;
        overflow-y: auto;
        background-color: white;

        #hamburger-icon {
            width: 40px;
            height: 40px;
            color: grey;
            position: absolute;
            right: 5px;
            top: 5px;
        }
        #hamburger-icon i {
            font-size: 26px;
            margin: 7px;
        }

        .items {
            height: calc(100% - 50px);
            width: fit-content;
            position: absolute;
            bottom: 0;
            scrollbar-width: none;
            overflow-y: auto;
            
            ::-webkit-scrollbar {display: none;}
            
            .item {
                width: var(--nav-bar-item-width);
                padding: 10px;
                border-radius: 7px;
                min-height: 55px;
                display: flex;
                align-items: center;
            }
            .item div {
                margin: auto;
            }
            .item:hover {
                background-color: #ededed;
            }
        }
    }
    #nav-bar.expanded-nav-bar {
        transform: unset !important;
    }
    
    .party-main {
        height: fit-content;
        width: calc(100% - var(--nav-bar-width));
        position: relative;
        left: var(--nav-bar-width);
        top: 0;
    }
    
    .media-container-block {
        margin-top: 10px;
        position: relative;
        width: 100%;
        height: var(--media-container-height);
        
        .media-container {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: center;
            
            .music-title-container {
                --music-title-size: calc(var(--media-container-height) - 100px);
            
                position: relative;
                margin: auto;
                width: var(--music-title-size);
                height: var(--music-title-size);

                .music-title {
                    --music-title-content-height: calc(var(--media-container-height) / 4);
                    position: absolute;
                    width: calc(var(--music-title-size) - 50px);
                    text-align: center;
                    color: white;
                    font-size: calc(var(--music-title-content-height) / 2);
                    z-index: 2;
                    height: var(--music-title-content-height);
                    line-height: var(--music-title-content-height);
                    margin-top: calc((var(--music-title-size) - var(--music-title-content-height)) / 2);
                    margin-left: 25px;
                    -webkit-text-stroke: 1px black;
                    overflow: hidden;

                    .music-title-text {
                        animation-name: music-title-scroll;
                        animation-iteration-count: infinite;
                        animation-timing-function: linear;
                        text-wrap: nowrap;
                        width: fit-content;
                        user-select: none;
                    }
                }
            }
            
            #video-component,
            #audio-component {
                max-height: 100%;
                max-width: 100%;
                
                margin: auto;
                display: none;
            }
        }
            
        .media-container i {
            font-size: var(--music-title-size);
            color: rgb(50 50 50);
            display: block;
            height: 100%;
            width: 100%;
            position: absolute;

        }
        .media-container i::before {
            vertical-align: 1em;
        }
    }
    
    .media-interactive-container {
        --media-progress-container-padding: 15px;
        --media-progress-bar-height: 6px;
    
        position: relative;
        width: 50%;
        margin: auto;
        margin-bottom: 20px;
        height: calc(var(--media-progress-container-padding) * 2 + var(--media-progress-bar-height));
        padding: var(--media-progress-container-padding) 0px;
        user-select: none;
        
        --media-progress-bar-elem-width: 100%;

        .bar {
            position: absolute;
            width: var(--media-progress-bar-elem-width);
            height: var(--media-progress-bar-height);
            background-color: lightgray;
            border-radius: 10px;
            overflow: hidden;
            pointer-events: none;
        }
        
        .bg {
            position: absolute;
            width: var(--media-progress-bar-elem-width);
            height: var(--media-progress-bar-height);
            border-radius: 10px;
            background-color: red;
            transform-origin: right center;
            left: calc(0px - var(--media-progress-bar-elem-width));
        }
    
        #node {
            position: absolute;
            left: -7px;
            pointer-events: none;
            top: 11px;
            width: 14px;
            height: 14px;
            background-color: white;
            border: 1px solid black;
            border-radius: 15px;
        }
    }
    .media-interactive-container i {
        position: absolute;
        font-size: 21px;
        top: 3px;
        left: -30px;
    }
    .media-interactive-container i:last-child {
        right: -30px;
        left: unset;
    }
    .media-interactive-container i:hover {
        cursor: default;
    }
    .media-interactive-container#media-volume-interactive { width: 30%; margin-top: 20px; }
    
    .controllers {
        margin-top: 10px;
        position: relative;
        width: 100%;
        height: fit-content;
        text-align: center;
        display: flex;
        align-items: center;

        .controller {
            display: inline-block;
            margin: 0px 5px;
        }
        .controller i {
            font-size: var(--controllers-height);
            line-height: var(--controllers-height);
        }
        .controller:first-child {
            margin-left: auto;
        }
        .controller:last-child {
            margin-right: auto;
        }
        .controller.sub-icon i {
            font-size: calc(var(--controllers-height) - 10px);
        }
    }

    .overflow-observer {
        position: relative;
        width: 100%;
        height: 10px;
    }
    .overflow-observer:first-child {
        position: absolute;
    }
}

/* popup windows */
#upload-media-container {

    .upload-file-container {
        position: relative;
        margin: auto;
        width: 100%;
        height: 300px;
        border: 20px dashed lightgray;
        border-radius: 10px;

        .show-upload,
        #files-input {
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            border-radius: inherit;
        }
        
        .show-upload {
            z-index: 1;
            display: flex;
            align-items: center;
        }
        .show-upload span {
            display: block;
            margin: auto;
            font-size: 30px;
            font-weight: 500;
            color: gray;
        }
        
        #files-input {
            opacity: 0;
            z-index: 2;
            box-sizing: border-box;
        }
    }
    
    .progress-bar {
        --progress-bar-height: 40px;
    
        width: 100%;
        height: var(--progress-bar-height);
        border-radius: 10px;
        border: 1px solid lightgray;
        margin: auto;
        margin-top: 20px;
        position: relative;
        overflow: hidden;
        
        .progress-text, input,
        .progress-background {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            border: unset;
            padding: 0px 20px;
            border-radius: inherit;
            box-sizing: border-box;
        }
        
        .progress-text {
            line-height: var(--progress-bar-height);
            user-select: none;
            text-wrap: nowrap;
            min-width: 100%;
            width: fit-content;
        }
        .progress-background {
            z-index: 1;
            border-radius: unset;
            padding: unset;
            transform: translateX(-100%);
            background-color: lightgreen;
        }
        
        .remove-file {
            position: absolute;
            z-index: 2;
            right: 0;
            height: var(--progress-bar-height);
            width: var(--progress-bar-height);
            top: 0;
            display: flex;
        }
        .remove-file i {
            margin: auto;
        }
    }
    
    .btn-container {
        width: 100%;
        height: fit-content;
        margin-top: 20px;
        display: flex;
    }
    .btn-container button {
        display: inline-block;
        width: 100%;
        height: 40px;
        margin: 0 10px;
        border-radius: 10px;
        border: none;
        background-color: dodgerblue;
        color: white;
        font-size: 17px;
        box-sizing: border-box;
    }
    .btn-container button:hover {cursor: pointer;}
    .btn-container button:first-child { margin-left: unset; }
    .btn-container button:last-child { margin-right: unset; }
}

#playlist-main {
    --media-height: 50px;
    --focus-color: #ededed;
    
    .media {
        width: 100%;
        height: var(--media-height);
        line-height: var(--media-height);
        border-radius: 5px;
        padding: 0px 5px;
        overflow: hidden;

        .title-text {
            text-wrap: nowrap;
            width: fit-content;
        }
    }
    .media:hover {
        background-color: var(--focus-color);
    }
    
    .playing {
        background-color: var(--focus-color);
        color: red;
    }
    .playing:hover {
        background-color: #e0e0e0;
    }
    
    .info {
        text-align: center;
        font-size: 30px;
        margin-top: 10vh;
    }
}

#upload-manager-main {
    .info {
        text-align: center;
        font-size: 30px;
        margin-top: 10vh;
    }

    .manage-block {
        margin: 20px 0px;
        padding: 20px 5px;
        border-bottom: 1px dashed grey;
        
        .title {
            width: calc(100% + 10px);
            height: 50px;
            padding: 0px 15px;
            box-sizing: border-box;
            font-size: 17px;
            border-radius: 7px;
            border: 1px solid;
            margin-left: -5px;
        }
    
        .status {
            margin: 20px 0px 5px 0px;
        }
    
        .progress-bar {
            width: 100%;
            height: 7px;
            border: 1px solid;
            border-radius: 5px;
            overflow: hidden;
            position: relative;

            .progress-bar-bg {
                width: 100%;
                height: 100%;
                position: absolute;
                transform: -100%;
                background-color: lightgreen;
            }
        }
    
        .function-btn {
            display: inline-block;
            margin-top: 20px;
            border-radius: 10px;
            margin-right: 40px;
            user-select: none;
        }
        .function-btn.danger {
            color: red;
        }
    
        :first-child {
            margin-top: unset;
        }
    
        :last-child {
            border-bottom: unset;
            margin-bottom: unset;
        }
    }
    .manage-block:first-child {margin-top: unset;}
    .manage-block:last-child {margin-bottom: unset;}
}

.room-popup { padding-top: 30px; }
.room-popup .room-info {
    font-size: 25px;
    text-align: center;
    display: block;
    margin-bottom: 30px;
}
.room-popup button, .room-popup input[type='text'] {
    width: 70%;
    display: block;
    height: 55px;
    font-size: 20px;
    border-radius: 10px;
    border: 1px solid;
    margin: auto;
    margin-bottom: 20px;
    background-color: dodgerblue;
    color: white;
}
.room-popup input[type='text'] {
    box-sizing: border-box;
    text-align: center;
    background: initial;
    color: initial;
    margin-top: 50px;
}
/* mobile view */
@media screen and (max-width: 1023px) {
    #notification-container .notification {
        width: 50%;
        font-size: 40px;
        border-radius: 15px;
    }

    #popup-container #popup-window {
        width: 90%;
        margin: 25% 5%;
        border-radius: 15px;
    }

    #login-form {
        --input-width: 90vw;
        --input-height: 100px;
        --show-pass-icon-height: 50px;
        font-size: 50px;

        #show-password i::before {
            vertical-align: 1em;
        }
        .remember-password-container input {
            margin-right: 15px;
            width: 40px;
            height: 40px;
        }
    }
    #login-form button {
        font-size: 35px;
        border-radius: 15px;
    }
    #login-form input:not(input[type='checkbox']) {
        border-radius: 15px;
        padding: 0 40px;
        font-size: 35px;
    }

    #playlist-main {
        --media-height: 100px;

        .media {
            border-radius: 15px;
            
            .title-text {
                font-size: 40px;
            }
        }

        .info {
            font-size: 40px;
        }
    }


    #party {
        --nav-bar-width: 0px;
        --media-container-height: 800px;
        --controllers-height: 60px;

        #nav-bar {
            width: 100%;
            height: fit-content;
            position: relative;
            transform: none;
            border-right: unset;
            padding: var(--nav-bar-left-padding);
            overflow: unset;
            transition-duration: unset;

            #hamburger-icon {
                display: none;
            }
        
            .items {
                height: fit-content;
                width: 100%;
                position: relative;

                .item {
                    width: 100%;
                    padding: 20px;
                    border-radius: 15px;
                    font-size: 40px;
                }
            }
        }
    
        #node {
            top: 25px !important;
            width: 25px !important;
            height: 25px !important;
            border-radius: 25px !important;
        }
    
        .party-main {
            position: relative;
        }
    
        .controllers .controller {
            margin: 0px 30px;
        }
    
        .media-interactive-container {
            --media-progress-container-padding: 30px;
            --media-progress-bar-height: 15px;
            width: 80%;
        }
        .media-interactive-container#media-volume-interactive {
            width: 50%;
        }
        .media-interactive-container#media-volume-interactive i {
            font-size: 40px;
            top: 8px;
            left: -50px;
        }
        .media-interactive-container#media-volume-interactive i:last-child {
            left: unset !important;
            right: -50px !important;
        }
        
        .media-container .music-title-container .music-title {
            -webkit-text-stroke: 2px black;
        }
    }


    #upload-media-container{

        .upload-file-container {
            height: 500px;

            .show-upload span {
                font-size: 50px;
            }
        }
    
        .progress-bar {
            --progress-bar-height: 100px;
            border-width: 5px;
        
            .progress-text {
                font-size: 30px;
            }
        
            .remove-file i {
                font-size: 30px;
            }
            .remove-file i::before {
                vertical-align: unset;
            }
        }
        .progress-bar input {
            font-size: 30px;
        }
    
        .btn-container {
            display: block;
            margin-top: 30px;
        }
        .btn-container button {
            margin: unset;
            margin-bottom: 20px;
            font-size: 30px;
            border-radius: 15px;
            display: block;
            height: 70px;
        }
    }

    #upload-manager-main {
        .manage-block {
            .title {
                height: 100px;
                padding: 0px 20px;
            }

            .progress-bar {
                height: 12px;
            }
        }
        .manage-block * {
            font-size: 30px !important;
        }
    }

    .room-popup .room-info {
        font-size: 45px;
        margin: 100px 0px;
    }
    .room-popup button, .room-popup input[type='text'] {
        width: 90%;
        height: 100px;
        font-size: 35px;
        margin-bottom: 30px;
    }
    .room-popup input[type='text'] {
        margin-top: 100px;
    }
}
        </style>
        <title>音趴</title>
    </head>
    <body>
        <div id="notification-container"></div>
        <div id="popup-container"><div id="popup-window"></div></div>
        <div id="main"></div>
    </body>
</html>